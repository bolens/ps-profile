name: Security - Dependency Update & Vulnerability Scan

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  schedule:
    # Run weekly on Mondays at 3 AM UTC
    - cron: '0 3 * * 1'
  workflow_dispatch:

jobs:
  scan-powershell-modules:
    name: Scan PowerShell Modules
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup PowerShell
        uses: actions/setup-powershell@v1
        with:
          pwsh-version: '7.4'

      - name: Check for Module Updates
        id: check-modules
        run: |
          pwsh -NoProfile -File scripts/utils/dependencies/check-module-updates.ps1 -ReportFile scripts/data/module-updates.json
        continue-on-error: true

      - name: Comment PR with Update Status
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            
            try {
              // Check if update report exists
              const reportPath = 'scripts/data/module-updates.json';
              if (fs.existsSync(reportPath)) {
                const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
                
                if (report.AvailableUpdates && report.AvailableUpdates.length > 0) {
                  let body = 'ðŸ“¦ **Dependency Update Check**\n\n';
                  body += '**Modules with available updates:**\n\n';
                  
                  report.AvailableUpdates.slice(0, 10).forEach(update => {
                    body += `- **${update.ModuleName}**\n`;
                    body += `  - Current: ${update.CurrentVersion || 'N/A'}\n`;
                    body += `  - Latest: ${update.LatestVersion || 'N/A'}\n`;
                    if (update.ReleaseNotes) {
                      body += `  - [Release Notes](${update.ReleaseNotes})\n`;
                    }
                    body += '\n';
                  });
                  
                  if (report.AvailableUpdates.length > 10) {
                    body += `\n*...and ${report.AvailableUpdates.length - 10} more module(s)*\n`;
                  }
                  
                  body += '\nðŸ’¡ *Consider updating dependencies to get the latest features and security fixes.*';
                  
                  github.rest.issues.createComment({
                    issue_number: context.issue.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: body
                  });
                } else {
                  github.rest.issues.createComment({
                    issue_number: context.issue.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: 'âœ… **Dependency Update Check**\n\nAll dependencies are up to date.'
                  });
                }
              }
            } catch (error) {
              console.log('Failed to post update comment:', error.message);
            }

  scan-npm-dependencies:
    name: Scan NPM Dependencies
    runs-on: ubuntu-latest
    if: hashFiles('package.json') != '' || hashFiles('package-lock.json') != ''
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'

      - name: Run npm audit
        id: npm-audit
        run: |
          if [ -f "package.json" ]; then
            npm audit --audit-level=moderate --json > npm-audit-results.json || true
          fi
        continue-on-error: true

      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: npm-audit-results
          path: npm-audit-results.json
          if-no-files-found: ignore

